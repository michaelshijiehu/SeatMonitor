<!DOCTYPE html>
<html>
<head>
    <title>å·¥ä½åœ°å›¾ - å®æ—¶ç›‘æ§</title>
    <style>
        body { margin: 0; background: #f4f4f4; overflow: hidden; font-family: sans-serif; }
        #map-container { position: relative; display: inline-block; }
        #floor-map { display: block; max-width: 100%; height: auto; }
        
        .seat-indicator {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s;
        }
        .seat-indicator:hover { transform: translate(-50%, -50%) scale(1.5); z-index: 10; }
        
        .status-free { background-color: #28a745; } /* ç»¿è‰²-ç©ºé—² */
        .status-busy { background-color: #dc3545; } /* çº¢è‰²-å ç”¨ */
        .status-unknown { background-color: #6c757d; } /* ç°è‰²-æœªçŸ¥ */

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 100;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div id="map-container">
        <!-- è¿™é‡Œçš„å›¾ç‰‡è·¯å¾„å’Œ JSON æ•°æ®åœ¨å®é™…éƒ¨ç½²æ—¶åº”åŠ¨æ€åŠ è½½ -->
        <img id="floor-map" src="/static/maps/floor1.png">
        <div id="indicators-layer"></div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // 1. åŠ è½½åæ ‡æ•°æ® (è¿™é‡Œå‡è®¾æœ‰ä¸€ä¸ª floor1_coords.json)
        // å®é™…åœºæ™¯ä¸­ï¼Œæ‚¨å¯ä»¥å°†æ­¤ JSON å†…å®¹ç›´æ¥æ¸²æŸ“åˆ°æ¨¡æ¿é‡Œï¼Œæˆ–è€… fetch åŠ è½½
        let seatCoords = []; 
        
        // æ¨¡æ‹ŸåŠ è½½åæ ‡ (è¯·ä½¿ç”¨ç¼–è¾‘å™¨ç”Ÿæˆåæ›¿æ¢è¿™é‡Œ)
        // seatCoords = [ {id: "A-100", x: 20.5, y: 30.1}, ... ];
        
        async function loadData() {
            try {
                // åŠ è½½åæ ‡é…ç½®
                const coordsRes = await fetch('/static/maps/floor1_coords.json');
                seatCoords = await coordsRes.json();
                
                // åŠ è½½å®æ—¶çŠ¶æ€
                const statusRes = await fetch('/api/mappings');
                const statusData = await statusRes.json();
                
                // è½¬æ¢ä¸º Map æ–¹ä¾¿æŸ¥æ‰¾
                const statusMap = new Map();
                statusData.forEach(item => {
                    // åˆ¤æ–­æ˜¯å¦åœ¨çº¿
                    let isOnline = false;
                    if (item.last_user && item.last_user.is_active) {
                        isOnline = true;
                    }
                    statusMap.set(item.seat_id, {
                        online: isOnline,
                        user: item.last_user ? item.last_user.user_name : null,
                        last_seen: item.last_user ? item.last_user.last_seen : null
                    });
                });

                renderMap(seatCoords, statusMap);
                
            } catch (e) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", e);
                // alert("è¯·ç¡®ä¿ /static/maps/floor1_coords.json å­˜åœ¨");
            }
        }

        function renderMap(coords, statusMap) {
            const layer = document.getElementById('indicators-layer');
            layer.innerHTML = '';
            
            coords.forEach(pt => {
                const el = document.createElement('div');
                el.className = 'seat-indicator';
                el.style.left = pt.x + '%';
                el.style.top = pt.y + '%';
                
                // ç¡®å®šçŠ¶æ€
                const info = statusMap.get(pt.id);
                if (info) {
                    if (info.online) {
                        el.classList.add('status-busy');
                    } else {
                        el.classList.add('status-free'); // æœ‰ç»‘å®šä½†ç¦»çº¿ -> ç©ºé—²
                    }
                } else {
                    el.classList.add('status-unknown'); // æ²¡ç»‘å®šè¿‡ -> æœªçŸ¥/ç©º
                }
                
                // äº¤äº’
                el.addEventListener('mouseenter', (e) => showTooltip(e, pt.id, info));
                el.addEventListener('mouseleave', hideTooltip);
                
                layer.appendChild(el);
            });
        }

        const tooltip = document.getElementById('tooltip');
        function showTooltip(e, id, info) {
            let text = `<b>${id}</b><br>`;
            if (info) {
                text += info.online ? "ğŸ”´ ä½¿ç”¨ä¸­" : "ğŸŸ¢ ç©ºé—²";
                if (info.user) text += `<br>ç”¨æˆ·: ${info.user}`;
                if (info.last_seen) text += `<br>æœ€åæ´»è·ƒ: ${info.last_seen}`;
            } else {
                text += "âšªï¸ æœªé…ç½®";
            }
            tooltip.innerHTML = text;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 15) + 'px';
            tooltip.style.top = (e.pageY + 15) + 'px';
        }

        function hideTooltip() {
            tooltip.style.display = 'none';
        }

        // å¯åŠ¨
        loadData();
        // æ¯ 10 ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
        setInterval(loadData, 10000);

    </script>
</body>
</html>
