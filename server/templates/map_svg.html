<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½å®æ—¶å…¨æ™¯å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* å®¹å™¨ */
        #scene-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: grab; }
        #scene-container:active { cursor: grabbing; }
        
        /* SVG æ ·å¼ */
        svg { max-width: 100%; height: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); background: white; border-radius: 8px; }
        
        /* å·¥ä½äº¤äº’æ ·å¼ */
        .seat { cursor: pointer; transition: all 0.3s ease; }
        .seat rect { transition: fill 0.3s ease, stroke 0.3s ease; }
        .seat:hover rect { stroke: #3b82f6; stroke-width: 3; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }

        /* çŠ¶æ€é¢œè‰²å®šä¹‰ */
        .seat-free rect { fill: #dcfce7 !important; stroke: #22c55e !important; } /* ç»¿è‰² */
        .seat-busy rect { fill: #fee2e2 !important; stroke: #ef4444 !important; } /* çº¢è‰² */
        .seat-unknown rect { fill: #f1f5f9 !important; stroke: #94a3b8 !important; } /* ç°è‰² */

        /* æ‚¬æµ®é¢æ¿ */
        .dashboard-panel {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 100;
        }
        .dashboard-panel h2 { margin: 0 0 10px 0; font-size: 18px; color: #1e293b; }
        .stat-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #475569; }
        .stat-badge { padding: 2px 8px; border-radius: 999px; font-weight: bold; font-size: 12px; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }

        /* Tooltip */
        #tooltip {
            position: absolute; display: none;
            background: #1e293b; color: white;
            padding: 8px 12px; border-radius: 6px;
            font-size: 13px; pointer-events: none;
            z-index: 999;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <!-- æ‚¬æµ®ç»Ÿè®¡é¢æ¿ -->
    <div class="dashboard-panel">
        <h2>ğŸ¢ AåŒºå®æ—¶çŠ¶æ€</h2>
        <div class="stat-item">
            <span>ç©ºé—²å·¥ä½</span>
            <span class="stat-badge bg-green" id="count-free">0</span>
        </div>
        <div class="stat-item">
            <span>ä½¿ç”¨ä¸­</span>
            <span class="stat-badge bg-red" id="count-busy">0</span>
        </div>
        <div style="font-size: 12px; color: #94a3b8; margin-top: 10px;">æ•°æ®æ¯ 5 ç§’åˆ·æ–°</div>
    </div>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="scene-container">
        <!-- SVG å°†é€šè¿‡ fetch åŠ¨æ€æ³¨å…¥åˆ°è¿™é‡Œ -->
        <div id="svg-wrapper"></div>
    </div>

    <!-- é¼ æ ‡æç¤º -->
    <div id="tooltip"></div>

    <script>
        const container = document.getElementById('svg-wrapper');
        const tooltip = document.getElementById('tooltip');
        let panzoomInstance = null;

        // 1. åŠ è½½ SVG åœ°å›¾
        async function loadMap() {
            try {
                // Fetch SVG raw text
                const response = await fetch('/static/maps/floor1.svg');
                const svgText = await response.text();
                container.innerHTML = svgText;

                // åˆå§‹åŒ– Panzoom (æ‹–æ‹½ç¼©æ”¾)
                const elem = container.querySelector('svg');
                panzoomInstance = Panzoom(elem, {
                    maxScale: 5,
                    minScale: 0.5,
                    contain: 'outside'
                });
                elem.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);

                // ç»‘å®šäº¤äº’äº‹ä»¶
                bindEvents();
                // é¦–æ¬¡åŠ è½½æ•°æ®
                updateStatus();
            } catch (e) {
                container.innerHTML = "<p style='color:red'>åŠ è½½åœ°å›¾å¤±è´¥: " + e.message + "</p>";
            }
        }

        // 2. ç»‘å®š SVG å†…éƒ¨äº‹ä»¶
        function bindEvents() {
            const seats = document.querySelectorAll('.seat'); // SVG ä¸­æ‰€æœ‰ class="seat" çš„ç»„
            seats.forEach(seat => {
                seat.addEventListener('mouseenter', (e) => {
                    const id = seat.getAttribute('data-id');
                    const info = currentStatus.get(id);
                    showTooltip(e, id, info);
                });
                seat.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });
        }

        // 3. çŠ¶æ€æ›´æ–°é€»è¾‘
        let currentStatus = new Map();

        async function updateStatus() {
            try {
                const res = await fetch('/api/mappings');
                const data = await res.json();
                
                currentStatus.clear();
                let freeCount = 0;
                let busyCount = 0;

                // å°†æ•°æ®è½¬ä¸º Map
                data.forEach(item => {
                    const isOnline = item.last_user && item.last_user.is_active;
                    currentStatus.set(item.seat_id, {
                        online: isOnline,
                        user: item.last_user?.user_name,
                        time: item.last_user?.last_seen
                    });
                });

                // éå† SVG ä¸­çš„æ‰€æœ‰å·¥ä½å…ƒç´ 
                const svgSeats = document.querySelectorAll('.seat');
                svgSeats.forEach(el => {
                    const seatId = el.getAttribute('data-id');
                    const info = currentStatus.get(seatId);

                    // ç§»é™¤æ—§çŠ¶æ€
                    el.classList.remove('seat-free', 'seat-busy', 'seat-unknown');

                    if (info) {
                        if (info.online) {
                            el.classList.add('seat-busy');
                            busyCount++;
                        } else {
                            el.classList.add('seat-free');
                            freeCount++;
                        }
                    } else {
                        el.classList.add('seat-unknown');
                        // æœªçŸ¥ç®—ç©ºé—²å—ï¼Ÿé€šå¸¸ä¸ç®—åœ¨ç»Ÿè®¡é‡Œï¼Œæˆ–è€…ç®—æœªçŸ¥
                    }
                });

                // æ›´æ–°é¢æ¿æ•°å­—
                document.getElementById('count-free').innerText = freeCount;
                document.getElementById('count-busy').innerText = busyCount;

            } catch (e) {
                console.error("çŠ¶æ€æ›´æ–°å¤±è´¥", e);
            }
        }

        function showTooltip(e, id, info) {
            let html = `<strong>${id}</strong>`;
            if (info) {
                if (info.online) {
                    html += `<br><span style="color:#f87171">â— ä½¿ç”¨ä¸­</span>`;
                    html += `<br>${info.user}`;
                } else {
                    html += `<br><span style="color:#4ade80">â— ç©ºé—²</span>`;
                    if (info.user) html += `<br><small>ä¸Šæ¬¡: ${info.user}</small>`;
                }
            } else {
                html += `<br><span style="color:#94a3b8">â— æœªé…ç½®</span>`;
            }
            
            tooltip.innerHTML = html;
            tooltip.style.display = 'block';
            
            // ç®€å•çš„è·Ÿéšé€»è¾‘ï¼Œå®é™…å¯èƒ½éœ€è¦è®¡ç®—è¾¹ç•Œ
            tooltip.style.left = (e.pageX + 15) + 'px';
            tooltip.style.top = (e.pageY + 15) + 'px';
        }

        // å¯åŠ¨
        loadMap();
        setInterval(updateStatus, 5000); // æ¯ 5 ç§’è½®è¯¢

    </script>
</body>
</html>
